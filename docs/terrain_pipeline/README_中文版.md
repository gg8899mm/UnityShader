# 矿业数字孪生项目 - 瓦片流式系统完整指南

## 欢迎！👋

本文档套件为矿业数字孪生项目的**瓦片流式处理系统**提供完整的中文支持。无论您是GIS工具新手还是Unity开发者，都能在这里找到详细的步骤指导。

---

## 📚 文档导航

### 如果您想要...

#### 🗺️ **生成瓦片数据** (QGIS处理)
→ 阅读：**[QGIS_工作流.md](QGIS_工作流.md)**

内容包括：
- 从天地图/奥维地图下载卫星影像和高程数据
- QGIS环境配置和重投影
- 生成z14-z18基础瓦片
- 为6-7个建筑群生成z19-z20高精度瓦片
- 完整的质量验证和故障排查

**推荐耗时**：1-3小时（首次完整流程）

---

#### 🖼️ **优化瓦片文件** (PNG → KTX2)
→ 阅读：**[PNG转KTX2.md](PNG转KTX2.md)**

内容包括：
- KTX-Software工具安装和PATH配置
- PowerShell批量转换脚本（完整可复制）
- 转换进度监控和质量验证
- 两种压缩模式对比（ETC1S vs UASTC）

**可选但推荐**：可节省70%的磁盘/显存空间

---

#### ⚙️ **在Unity中集成瓦片系统** (代码集成)
→ 阅读：**[Unity_TileStreamer集成.md](Unity_TileStreamer集成.md)**

内容包括：
- 项目准备和依赖安装
- 场景设置（GameObject、Material、LOD配置）
- TileStreamer脚本详细配置
- 多ROI优先级加载机制
- 调试和常见问题排查

**推荐耗时**：1-2小时

---

#### 📍 **解决坐标系对齐问题** (地理坐标 ↔ Unity坐标)
→ 阅读：**[坐标对齐与场景设置.md](坐标对齐与场景设置.md)**

内容包括：
- Web Mercator坐标系基础
- 经纬度 ↔ 投影坐标 ↔ 瓦片坐标的转换
- Unity场景原点设置
- 地形Tile拆分方案
- 完整的坐标转换工具类代码

**关键**：正确的坐标对齐确保数据准确

---

#### ⚡ **优化性能** (显存管理、LOD调优)
→ 阅读：**[性能优化.md](性能优化.md)**

内容包括：
- Texture Streaming启用和配置
- 显存预算计算和管理
- LOD参数调优
- 并发加载优化
- Profiler使用和性能基准
- 常见问题排查

**推荐**：每个阶段都应参考此文档

---

## 🚀 快速开始（3-5步）

### 对于"程序小白、GIS工具陌生"的新用户

#### 第1步：准备地理数据（30分钟）

```
1. 访问 https://www.tianditu.gov.cn/
2. 注册免费账户
3. 下载矿区卫星影像 (42×48km范围)
   - 格式：GeoTIFF
   - 分辨率：尽可能高
4. 可选：下载高程DEM数据
```

**下一步**：进入 → **QGIS_工作流.md § 1数据下载准备**

---

#### 第2步：使用QGIS生成瓦片（1.5-2小时）

**必须做的**：
1. 下载安装 QGIS (https://qgis.org)
2. 按照 **QGIS_工作流.md** 完成：
   - §2 QGIS环境配置
   - §3 重投影到Web Mercator
   - §4 裁剪到矿区范围
   - §5 生成基础瓦片(z14-z18)
   - §6 生成ROI高精度瓦片(z19-z20)×7

**输出**：
```
tiles_base/          (~150-500 MB)
tiles_roi_building1/ (~50-300 MB)
tiles_roi_building2/
... (7个ROI)
```

**可选优化**：→ **PNG转KTX2.md** 转换为KTX2格式

---

#### 第3步：在Unity中配置场景（1小时）

1. **打开Unity项目** (Unity 2023.1 + Built-in RP)

2. **复制瓦片文件**
   ```
   Assets/StreamingAssets/
   ├── tiles_base/
   ├── tiles_roi_building1/
   ├── tiles_roi_building2/
   └── ... (7个)
   ```

3. **按照 Unity_TileStreamer集成.md 配置**
   - §2 场景设置（Quad、Camera、Material）
   - §3 脚本配置（TileStreamer、TileStreamerExample）

4. **按 Unity_TileStreamer集成.md § 7 运行测试**
   - Play启动
   - 相机移动时看到瓦片加载
   - 检查Console无错误

---

#### 第4步：验证坐标对齐（30分钟）

1. **在QGIS中记录某点的Web Mercator坐标**

2. **在Unity中使用 坐标对齐与场景设置.md § 5 的验证脚本**
   - 检查转换是否正确
   - 使用Debug.Log输出对比

3. **视觉检查**
   - 在QGIS打开的卫星影像上标记一个地标
   - 确保对应的Unity中瓦片显示相同地标

---

#### 第5步：性能优化（1小时）

按 **性能优化.md** 的检查清单：

```
□ 启用Texture Streaming
□ 设置Cache Memory MB (根据GPU调整)
□ 配置LOD参数 (nearZoom, midZoom, farRadius等)
□ 设置Max Concurrent Loads (4-8)
□ 使用Profiler监控 (FPS ≥ 30)
```

**完成！🎉**

---

## 📋 文档快速参考

| 文档 | 适用角色 | 优先级 | 关键章节 |
|-----|--------|------|--------|
| **QGIS_工作流.md** | GIS/地理数据处理人员 | ⭐⭐⭐ | §3-§6 (重投影、裁剪、生成瓦片) |
| **PNG转KTX2.md** | 系统管理员/优化工程师 | ⭐⭐ (可选) | §2-§3 (脚本安装、执行) |
| **Unity_TileStreamer集成.md** | Unity开发者 | ⭐⭐⭐ | §3-§4 (配置、加载逻辑) |
| **坐标对齐与场景设置.md** | 技术主管/资深工程师 | ⭐⭐⭐ | §1-§2 (坐标系、原点设置) |
| **性能优化.md** | 全体团队 | ⭐⭐⭐ | §2-§6 (每阶段参考) |

---

## 🔧 系统架构概览

```
┌─────────────────────────────────────┐
│   地理数据源                        │
│  (卫星影像 + DEM数据)              │
│  从天地图/奥维地图下载             │
└──────────────┬──────────────────────┘
               ↓
        ┌──────────────┐
        │   QGIS处理    │ ← 详见：QGIS_工作流.md
        │ • 重投影      │
        │ • 裁剪        │
        │ • 生成瓦片     │
        └──────┬───────┘
               ↓
    ┌──────────────────────┐
    │  PNG/KTX2 瓦片文件   │ ← 详见：PNG转KTX2.md
    │  tiles_base/         │  (z14-z18)
    │  tiles_roi_*         │  (z19-z20)
    └──────┬───────────────┘
           ↓
    ┌──────────────────────┐
    │  StreamingAssets/    │
    │  (复制到项目中)      │
    └──────┬───────────────┘
           ↓
    ┌──────────────────────────────┐
    │   Unity场景                  │ ← 详见：Unity_TileStreamer集成.md
    │ • TileStreamer组件           │
    │ • StreamingAssetsTileProvider │
    │ • LRU缓存系统               │
    │ • Web Mercator坐标系         │ ← 详见：坐标对齐与场景设置.md
    └──────┬───────────────────────┘
           ↓
    ┌──────────────────────────────┐
    │   显示和交互                  │
    │ • 实时瓦片加载/卸载          │
    │ • 多ROI优先级加载            │
    │ • 性能监控                    │ ← 详见：性能优化.md
    └──────────────────────────────┘
```

---

## 🎯 关键概念速查

### Web Mercator (EPSG:3857)
- 地理坐标系投影方式
- Google Maps/OSM标准
- 单位：米
- 范围：[±20037508 米]

### XYZ瓦片格式
- 文件路径：`/z/x/y.png`
- Z = 缩放级别 (14-20)
- X = 东西方向瓦片列
- Y = 南北方向瓦片行
- **重要**：使用XYZ标准（非TMS格式！）

### LOD (Level of Detail)
- z14：全矿区概览
- z15-z18：基础层
- z19-z20：建筑群高精度

### ROI (Region of Interest)
- 指矿业项目中的重点区域
- 建筑群1到建筑群7
- 需要z19-z20高精度瓦片

### LRU缓存
- 最近最少使用缓存
- 自动管理显存
- 旧瓦片自动卸载

---

## ❓ 常见问题速查

**Q: 我是GIS新手，从哪开始？**
A: 从 **QGIS_工作流.md** 开始，按顺序完成每一步。

**Q: 能直接用PNG还是必须转KTX2？**
A: PNG可用，KTX2可选但推荐（节省70%空间）。详见 **PNG转KTX2.md**。

**Q: 坐标不对齐怎么办？**
A: 阅读 **坐标对齐与场景设置.md § 5 验证流程**。

**Q: 帧率很低怎么优化？**
A: 参考 **性能优化.md § 7 性能问题排查**。

**Q: 能在移动设备上运行吗？**
A: 可以，但需要根据设备显存调整参数（见 **性能优化.md § 2**）。

---

## 📊 项目规模参考

### 输入数据量

```
卫星影像（原始）：     500MB - 2GB
高程数据（可选）：     100MB - 500MB
```

### 生成瓦片量

```
基础瓦片(z14-z18)：   450-680文件，150-500MB
ROI高精度×7(z19-z20)：2100-7000文件，350-2100MB
合计：                 3000-8000文件，500-2600MB
```

### 转换后（KTX2）

```
基础瓦片(z14-z18)：   100-150MB (↓70%)
ROI高精度×7(z19-z20)：100-600MB (↓70%)
合计：                 150-750MB (↓70%)
```

### 运行时显存

```
缓存预算：            256-1024MB（可配置）
单个瓦片：            200-500KB
```

---

## 👥 团队角色分工建议

| 角色 | 职责 | 阅读文档 |
|-----|-----|--------|
| **GIS工程师** | 数据下载、QGIS处理、瓦片生成 | QGIS_工作流.md (优先) |
| **系统管理员** | 工具安装、脚本部署、优化 | PNG转KTX2.md, 性能优化.md |
| **Unity开发者** | 场景集成、代码实现、调试 | Unity_TileStreamer集成.md (优先) |
| **项目经理** | 整体协调、进度跟踪 | 本README + 各文档摘要 |
| **技术主管** | 架构设计、性能目标 | 坐标对齐与场景设置.md, 性能优化.md |

---

## 📞 技术支持

### 遇到问题时

1. **查看对应文档的"常见问题"部分**
2. **检查文档中的"排查指南"**
3. **查看本README的"常见问题速查"**
4. **查看Unity Console的错误信息**
5. **使用Profiler进行性能诊断**

### 问题记录模板

```
【问题】
- 症状描述
- 重现步骤
- 硬件配置

【已尝试】
- 相关文档章节
- 尝试的方案

【附件】
- 错误截图
- Console输出
- Profiler数据
```

---

## 📚 补充资源

### 官方文档
- **QGIS官方**：https://qgis.org/en/docs/
- **Unity官方**：https://docs.unity3d.com/
- **Web Mercator详解**：https://wiki.openstreetmap.org/wiki/Slippy_map_tilenames

### 工具下载
- **QGIS下载**：https://qgis.org/en/site/forusers/download.html
- **KTX-Software**：https://github.com/KhronosGroup/KTX-Software/releases
- **Unity Hub**：https://unity3d.com/download

### 参考数据源
- **天地图**：https://www.tianditu.gov.cn/
- **SRTM DEM**：https://earthexplorer.usgs.gov/
- **OpenTopography**：https://cloud.sdsc.edu/v1/AUTH_opentopography

---

## 📝 版本历史

```
v1.0 (2024)
- ✅ 完整的中文文档套件
- ✅ 5个详细指南
- ✅ 快速开始指南
- ✅ 坐标转换工具代码
- ✅ PowerShell脚本
- ✅ 性能基准参考
```

---

## 📄 许可和使用条款

本文档适用于矿业数字孪生项目的内部使用。

---

## 🙏 致谢

感谢所有贡献者和用户的反馈，帮助我们不断完善这套文档系统。

---

**准备好开始了吗？** → 👉 阅读 **[QGIS_工作流.md](QGIS_工作流.md)** 或根据您的角色选择相应文档！
